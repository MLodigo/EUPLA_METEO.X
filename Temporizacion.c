/*
    MODULO QUE REALIZA TEMPORIZACIONES EN BASE A 1 MILISEGUNDO CON EL TIMER1
*/

#include "Temporizacion.h"
#include "General.h"
#include <p24fj128ga010.h>

//********************************************************************************************************************    
//********************************************************************************************************************    
//                                                VARIABLES MIEMBRO
//********************************************************************************************************************    
//********************************************************************************************************************    
PRIVATE UINT Cnt_MSeg = 0;

//********************************************************************************************************************    
//********************************************************************************************************************    
//                                               METODOS PRIVADOS
//********************************************************************************************************************    
//******************************************************************************************************************** 



//********************************************************************************************************************    
//********************************************************************************************************************    
//                                                 METODOS PUBLICOS
//********************************************************************************************************************
//********************************************************************************************************************    

//********************************************************************************************************************
//Funcion que configura el timer por interrupción a 1 milisegundo y lo arranca.
//********************************************************************************************************************
void Inicia_Temporizacion(void)
{
    //Timer 1 por interrupción a 1 segundo con prescaler a 256
    T1CON = 0b0000000000110000;
    TMR1 = 0x00;
    PR1 = (0.001/((256.0*2)/(8000000)));      //0.001 segundos = 1 MSeg.
    IFS0bits.T1IF = 0;
    IEC0bits.T1IE = 1;
    T1CONbits.TON = 1;

    Cnt_MSeg = 0; 
}

//********************************************************************************************************************
//Stop Timer.
//********************************************************************************************************************
void Detiene_Temporizacion(void)
{
    T1CONbits.TON = 0;
}

//********************************************************************************************************************
//Reinicia Timer sin configurarlo.
//********************************************************************************************************************
void Reinicia_Temporizacion(void)
{
    TMR1 = 0x00;
    T1CONbits.TON = 1;
}

//********************************************************************************************************************
//Pone a cero la variable contador de milisegundos.
//********************************************************************************************************************
void Reset_Contador_MSeg(void)
{
    Cnt_MSeg = 0;
}

//********************************************************************************************************************
//Lectura del contador de microsegundos.
//********************************************************************************************************************
UINT Lectura_Contador_MSeg(void)
{
    return Cnt_MSeg;
}

//********************************************************************************************************************
//Realiza un retardo de los milisegundos indicados.
//********************************************************************************************************************
void Retardo(UINT mseg)
{
    Reset_Contador_MSeg();
    while(Lectura_Contador_MSeg()<mseg);
}


//********************************************************************************************************************    
//********************************************************************************************************************    
//                                                INTERRUPCIONES
//********************************************************************************************************************    
//********************************************************************************************************************    

void __attribute__((interrupt, no_auto_psv)) _T1Interrupt(void)
{
    //Bajamos la bandera de interrupcción del timer
    IFS0bits.T1IF = 0;
    
    //Incrementa el contador de microsegundos
    Cnt_MSeg++;
}
